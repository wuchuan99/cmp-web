<template>
  <div class="vul-asset-list">
    <div class="vul-asset-main">
      <div class="vul-asset-title">资产关联 TOP10</div>
      <div class="table">
        <new-table
          class="newTable"
          ref="newTable"
          :border="true"
          :columns="columns"
          :data="assetList"
          highlight-current-row
          @current-change="handleCurrentChange"
        />
      </div>
    </div>
  </div>
</template>
<script>
import { debounce } from "@/utils/common";
import { getVulAssetbindvul } from "@/api/vul/vul-stats";
export default {
  data() {
    return {
      filterFlag: false,
      filterObj: {},
      assetList: [],
      columns: [
        { type: "index", label: "序号", width: 60, align: "center" },
        {
          prop: "assetIp",
          label: "资产关联",
          width: 150,
          align: "center",
          render: scope => <span class="theme">{scope.row.assetIp}</span>
        },
        {
          prop: "vulLevelInfo",
          label: "漏洞分布",
          render: scope => {
            let result = "";
            if (scope.row.vulLevelInfo) {
              for (const key in scope.row.vulLevelInfo) {
                if (Object.hasOwnProperty.call(scope.row.vulLevelInfo, key)) {
                  result += `${key}：${scope.row.vulLevelInfo[key]}，`;
                }
              }
              result = result.slice(0, result.length - 1);
            }
            return <span>{result}</span>;
          }
        }
      ],
      currentRow: null
    };
  },
  watch: {
    currentRow(val) {
      if (val?.assetId) {
        this.$emit("input", val.assetId);
      }
    }
  },
  methods: {
    handle: debounce(function({ action, value }) {
      this[action] && this[action](value);
    }, 200),
    // 更新漏洞列表
    getAssetVulList() {
      getVulAssetbindvul({ topN: 10 }).then(res => {
        const { success, data } = res.data;
        if (success) {
          this.assetList = data || [];
          this.setCurrent(this.assetList[0]);
        }
      });
    },
    setCurrent(row) {
      this.currentRow = row;
      this.$refs.newTable.$refs.table.setCurrentRow(row);
    },
    handleCurrentChange(val) {
      this.currentRow = val;
    }
  },
  created() {
    this.getAssetVulList();
  },
  mounted() {}
};
</script>
<style lang="scss" scoped>
@import "~@/style/mixin.scss";
@import "~@/style/constant.scss";
.vul-asset-list {
  width: 500px;
  background-color: white;
  box-shadow: 0px 2px 7px 0px rgba(0, 0, 0, 0.17);
  padding: 15px;
  @include scroll;
  .vul-asset-main {
    border: 1px solid #ebeef5;
    .vul-asset-title {
      font-size: 18px;
      font-weight: 700;
      color: #606266;
      padding: 10px;
      border-bottom: 1px solid #ebeef5;
    }
    .table {
      padding: 10px;
      :deep(.newTable) {
        &.el-table {
          .el-table__body {
            .el-table__row {
              cursor: pointer;
            }
          }
        }
      }
    }
  }
  .theme {
    color: $themeColor;
  }
}
</style>
