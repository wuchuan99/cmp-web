<template>
  <!-- <div>收录所有漏洞信息 漏洞列表 漏洞搜索 漏洞筛选 漏洞详情</div> -->
  <div class="vul-list">
    <div class="vul-list-header container">
      <div class="vul-list-header-container ">
        <div class="flex">
          <new-button
            :type="exportBtnType"
            :disabled="exportBtnType === 'loading'"
            @click="handle({ action: 'exportVuls' })"
            >导出</new-button
          >
        </div>
        <div class="flex">
          <new-button @click="showFilter = !showFilter" type="filter"
            >筛选</new-button
          >
          <new-search
            margin
            v-model="queryParams.keyword"
            class="search"
            @click="handle({ action: 'search' })"
            placeholder="请输入漏洞名称"
          />
        </div>
      </div>
      <!-- 筛选 -->
      <vulnerability-list-filter
        @sure="filterSure($event)"
        ref="filter"
        :visible.sync="showFilter"
      ></vulnerability-list-filter>
    </div>
    <div class="vul-list-container container" :class="{ filter: showFilter }">
      <new-table
        ref="newTable"
        :border="true"
        :columns="columns"
        :data="records"
      />
      <new-page
        :total.sync="total"
        :page.sync="pageIndex"
        :limit.sync="pageSize"
      />
    </div>
  </div>
</template>
<script>
import VulnerabilityListFilter from "./components/VulnerabilityListFilter.vue";
import PageMixins from "@/mixins/pagination";
import { debounce } from "@/utils/common";
import { getVulList } from "@/api/vul/vul-list";
export default {
  components: { VulnerabilityListFilter },
  mixins: [PageMixins],
  data() {
    return {
      showFilter: false,
      vulList: [],
      queryParams: {
        keyword: "",
        name: "",
        type: "",
        level: ""
      },
      columns: [
        { label: "漏洞名称", prop: "name" },
        { label: "漏洞编号", prop: "cveCode" },
        { label: "危害等级", prop: "level" },
        { label: "漏洞类型", prop: "type" },
        { label: "厂商", prop: "vendor" },
        { label: "收录时间", prop: "publishTime" },
        { label: "匹配时间", prop: "matchDate" },
        { label: "更新时间", prop: "updateTime" }
      ],
      exportBtnType: "export"
    };
  },

  methods: {
    handle: debounce(function({ action, value }) {
      this[action] && this[action](value);
    }, 200),
    search() {
      this.showFilter = false;
      this.queryParams.name = this.queryParams.keyword;
      this.clearFilterForm();
      if (this.pageIndex === 1) this.getRecords();
      else this.pageIndex = 1;
    },
    filterSure(data) {
      Object.assign(this.queryParams, data);
      this.queryParams.name = this.queryParams.name || this.queryParams.keyword;
      if (this.pageIndex === 1) this.getRecords();
      else this.pageIndex = 1;
    },
    clearFilterForm() {
      this.queryParams.type = "";
      this.queryParams.level = "";
      this.$refs["filter"].clearForm();
    },
    exportVuls() {
      this.exportBtnType = "loading";
      setTimeout(() => {
        this.exportBtnType = "export";
        this.$message.success("导出成功");
      }, 2000);
    }
  },
  created() {
    this.fetchFn = getVulList;
  },
  mounted() {
    this.getRecords();
  }
};
</script>
<style scoped lang="scss">
@import "~@/style/mixin.scss";
.vul-list {
  height: 100%;
  padding: 25px 0;
  .container {
    @include shadow;
    background-color: white;
    padding: 20px;
  }
  .vul-list-header {
    .vul-list-header-container {
      @include flex-space-between;
    }
  }
  .vul-list-container {
    margin-top: 15px;
    height: calc(100% - 92px);
    &.filter {
      height: calc(100% - 190px);
    }
  }
}
</style>
