<template>
  <new-drawer
    ref="drawer"
    @sure="handle('sure')"
    @close="handle('close')"
    :buttons="!disabled"
    :size="500"
  >
    <new-table
      ref="newTable"
      :key="table.columns.toString()"
      :border="true"
      :columns="table.columns"
      :data="records"
      :loading="loading"
    />
  </new-drawer>
</template>

<script>
import { debounce } from "@/utils/common";
import { resetObj, deepClone } from "@/utils/object";
export default {
  data() {
    return {
      loading: false,
      records: [],
      table: {
        columns: [
          { type: "selection" },
          { type: "index", label: "序号", width: 80 },
          { prop: "info", label: "产品信息" },
          { prop: "result", label: "验证结果" }
        ]
      },
      operateInfo: {
        type: "",
        id: ""
      }
    };
  },
  computed: {
    disabled() {
      return this.operateInfo.type === "view";
    }
  },
  created() {},
  mounted() {},
  methods: {
    show({ type, row }) {
      this.$refs["drawer"].show(type === "edit" ? "漏洞验证" : "风险资产");
      this.operateInfo.type = type;
      this.operateInfo.id = row?.id || "";
      this.setTableColumns();
      this.getDetail(row.id);
    },
    handle: debounce(function(action) {
      const operate = {
        sure: () => {
          const checkedList = this.$refs["newTable"].getSelection();
          if (!checkedList.length)
            return this.$message.error("*请选择表格数据后再提交*");
          console.log(checkedList);
          const drawer = this.$refs["drawer"];
          drawer.loading();
          this.submit()
            .then(() => {
              drawer.close();
              this.$emit("update", deepClone(this.operateInfo));
              this.$message.success("*操作成功*");
            })
            .finally(() => {
              drawer.closeLoading();
            });
        },
        close: () => {
          this.$nextTick(() => {
            resetObj(this.operateInfo);
          });
        }
      };
      operate[action] && operate[action]();
    }, 200),
    setTableColumns() {
      this.table.columns = this.table.columns.filter(
        item => item?.type === "index" || item?.prop === "info"
      );
      if (!this.disabled) {
        this.table.columns.unshift({ type: "selection" });
        this.table.columns.push({ prop: "result", label: "验证结果" });
      }
    },
    getDetail(id) {
      console.log(id);
      this.records = [
        {
          info: "IP 端口 服务",
          result: ""
        },
        {
          info: "IP 端口 服务",
          result: ""
        }
      ];
    },
    submit() {
      return Promise.resolve();
    }
  }
};
</script>
<style lang="scss" scoped></style>
